<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clever.txt | Professional Editor ‚òòÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Bad+Script&family=Caveat:wght@400;700&family=Comfortaa:wght@300;700&family=EB+Garamond:ital@0;1&family=Kelly+Slab&family=Lobster&family=Montserrat:wght@100;400;900&family=Oswald:wght@200;700&family=Pacifico&family=Playfair+Display:ital,wght@0,400;0,900;1,400&family=Press+Start+2P&family=Roboto+Mono:wght@100;700&family=Ruslan+Display&family=Underdog&family=Yeseva+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #27ae60;
            --accent-hover: #219150;
            --bg-main: #f0f2f5;
            --panel-bg: #ffffff;
            --text-dark: #2c3e50;
            --border-color: #dcdde1;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–æ–ª–ª */
        * { box-sizing: border-box; outline: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-main);
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER & LOGO */
        header {
            background: var(--panel-bg);
            padding: 10px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            user-select: none;
        }

        .clover-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            position: relative;
            clip-path: polygon(50% 0%, 100% 35%, 80% 100%, 50% 80%, 20% 100%, 0% 35%);
            transition: var(--transition);
        }

        .logo-group:hover .clover-icon {
            transform: rotate(15deg) scale(1.1);
            filter: brightness(1.2);
        }

        .logo-text {
            font-weight: 900;
            font-size: 1.6rem;
            letter-spacing: -1px;
            background: linear-gradient(45deg, var(--accent), #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* SHARING PANEL */
        .sharing-center {
            display: flex;
            gap: 15px;
        }

        .link-card {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .link-card:hover { border-color: var(--accent); background: #fff; }

        .link-card label {
            font-size: 10px;
            font-weight: 800;
            color: #95a5a6;
            text-transform: uppercase;
        }

        .link-card input {
            border: none;
            background: transparent;
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            color: var(--text-dark);
            width: 180px;
        }

        /* TOOLBAR */
        .main-toolbar {
            background: var(--panel-bg);
            padding: 8px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            z-index: 999;
        }

        .tool-group {
            display: flex;
            align-items: center;
            background: #f1f2f6;
            padding: 4px;
            border-radius: 10px;
            gap: 2px;
        }

        .tool-btn {
            background: transparent;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #57606f;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover {
            background: #fff;
            color: var(--accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tool-btn.active {
            background: var(--accent);
            color: #fff;
        }

        select.tool-select {
            border: none;
            background: transparent;
            padding: 5px;
            font-weight: 600;
            color: #57606f;
            cursor: pointer;
        }

        .color-picker-wrapper {
            position: relative;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        input[type="color"].invisible-picker {
            position: absolute;
            top: -10px; left: -10px;
            width: 60px; height: 60px;
            cursor: pointer;
        }

        /* VIEWPORT & EDITOR */
        .editor-viewport {
            flex: 1;
            overflow-y: auto;
            padding: 60px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            scroll-behavior: smooth;
        }

        .canvas-container {
            position: relative;
            width: 210mm;
            transition: var(--transition);
        }

        #editor {
            width: 100%;
            min-height: 297mm;
            background: #ffffff;
            padding: 25mm 20mm;
            box-shadow: var(--shadow);
            outline: none;
            color: #1e272e;
            font-size: 12pt;
            line-height: 1.8;
            position: relative;
            border-radius: 4px;
            word-wrap: break-word;
        }

        /* BACKGROUND STYLES */
        .paper-lined { background-image: repeating-linear-gradient(#fff, #fff 31px, #f1f2f6 32px) !important; }
        .paper-grid { background-image: 
            linear-gradient(to right, #f1f2f6 1px, transparent 1px),
            linear-gradient(to bottom, #f1f2f6 1px, transparent 1px) !important;
            background-size: 30px 30px !important; }
        .paper-dark { background-color: #2c3e50 !important; color: #ecf0f1 !important; }

        /* IMAGE STYLES */
        #editor img {
            max-width: 100%;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            display: block;
            margin: 15px auto;
        }

        #editor img:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* FLOATING ACTION BUTTON */
        .fab-save {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 70px;
            height: 70px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            box-shadow: 0 10px 25px rgba(39, 174, 96, 0.4);
            cursor: pointer;
            transition: var(--transition);
            z-index: 2000;
            border: none;
        }

        .fab-save:hover { transform: scale(1.1) rotate(90deg); background: var(--accent-hover); }

        /* MOBILE ADAPTATION */
        @media (max-width: 900px) {
            .canvas-container { width: 100%; }
            #editor { padding: 15mm 10mm; }
            .main-toolbar { padding: 15px 5px; }
            .sharing-center { display: none; }
            .fab-save { bottom: 20px; right: 20px; width: 60px; height: 60px; }
        }

        /* STATUS INDICATOR */
        .status-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-top: 1px solid var(--border-color);
            padding: 5px 20px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            color: #7f8c8d;
        }

        .online-dot {
            width: 8px; height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .online-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

    </style>
</head>
<body>

<header>
    <div class="logo-group" onclick="location.reload()">
        <div class="clover-icon"></div>
        <div class="logo-text">clever.txt</div>
    </div>
    <div class="sharing-center">
        <div class="link-card">
            <label>Edit</label>
            <input type="text" id="edit-url" readonly onclick="this.select()">
            <button class="tool-btn" onclick="copyValue('edit-url')">üìã</button>
        </div>
        <div class="link-card">
            <label>View</label>
            <input type="text" id="view-url" readonly onclick="this.select()">
            <button class="tool-btn" onclick="copyValue('view-url')">üìã</button>
        </div>
    </div>
</header>

<div class="main-toolbar" id="toolbar">
    <div class="tool-group">
        <select class="tool-select" id="fontSetter" onchange="exec('fontName', this.value)">
            <option value="Montserrat">Montserrat</option>
            <option value="Playfair Display">Playfair Display</option>
            <option value="Kelly Slab">Kelly Slab</option>
            <option value="Caveat">Caveat (Hand)</option>
            <option value="Roboto Mono">Code Mono</option>
            <option value="Lobster">Lobster Style</option>
            <option value="Ruslan Display">Old Style</option>
            <option value="Press Start 2P">Retro 8-Bit</option>
        </select>
        <select class="tool-select" onchange="exec('fontSize', this.value)">
            <option value="3">Size: 14pt</option>
            <option value="4">16pt</option>
            <option value="5">18pt</option>
            <option value="6">24pt</option>
            <option value="7">32pt</option>
        </select>
    </div>

    <div class="tool-group">
        <button class="tool-btn" onclick="exec('bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
        <button class="tool-btn" onclick="exec('italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
        <button class="tool-btn" onclick="exec('underline')" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
        <button class="tool-btn" onclick="exec('strikeThrough')" title="–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π"><s>S</s></button>
    </div>

    <div class="tool-group">
        <div class="color-picker-wrapper" title="–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞">
            <input type="color" class="invisible-picker" oninput="exec('foreColor', this.value)">
        </div>
        <button class="tool-btn" onclick="exec('insertUnorderedList')">Bullet List</button>
        <button class="tool-btn" onclick="exec('insertOrderedList')">Num List</button>
    </div>

    <div class="tool-group">
        <button class="tool-btn" onclick="exec('justifyLeft')">‚¨Ö</button>
        <button class="tool-btn" onclick="exec('justifyCenter')">‚¨Ü</button>
        <button class="tool-btn" onclick="exec('justifyRight')">‚û°</button>
        <button class="tool-btn" onclick="exec('justifyFull')">‚â°</button>
    </div>

    <div class="tool-group">
        <button class="tool-btn" onclick="setPaper('paper-lined')">Lines</button>
        <button class="tool-btn" onclick="setPaper('paper-grid')">Grid</button>
        <button class="tool-btn" onclick="setPaper('')">Clean</button>
        <button class="tool-btn" onclick="toggleDarkMode()">üåô</button>
    </div>

    <div class="tool-group">
        <button class="tool-btn" onclick="insertImage()" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üñº Image</button>
        <button class="tool-btn" onclick="window.print()">üìÑ PDF</button>
    </div>
</div>

<div class="editor-viewport" id="viewport">
    <div class="canvas-container">
        <div id="editor" contenteditable="true" spellcheck="false">
            <h1 style="text-align: center;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Clever.txt üçÄ</h1>
            <p>–≠—Ç–æ —Ç–≤–æ–π <b>–¥–µ—Ä–∑–∫–∏–π</b> –∏ –±—ã—Å—Ç—Ä—ã–π –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –≤ —Ç–≤–æ—é –ª–∏—á–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</p>
            <p><i>–ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å —Å—é–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∏–∑–º–µ–Ω–∏ —à—Ä–∏—Ñ—Ç –Ω–∞ –±–æ–ª–µ–µ –±–µ–∑—É–º–Ω—ã–π!</i></p>
            <hr>
            <blockquote>–¶–∏—Ç–∞—Ç—ã —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –ü—Ä–æ—Å—Ç–æ –≤—ã–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –∏ –Ω–∞—á–Ω–∏ —Ç–≤–æ—Ä–∏—Ç—å.</blockquote>
        </div>
    </div>
</div>

<button class="fab-save" id="saveFab" onclick="forceSave()" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ">
    ‚òòÔ∏è
</button>

<div class="status-bar">
    <div>
        <span class="online-dot" id="net-status"></span>
        <span id="status-text">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£...</span>
    </div>
    <div id="word-count">–°–ª–æ–≤: 0 | –°–∏–º–≤–æ–ª–æ–≤: 0</div>
    <div id="last-save">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –Ω–∏–∫–æ–≥–¥–∞</div>
</div>

<script>
    /**
     * CONFIGURATION
     */
    const API_HOST = "https://unharrowed-darleen-dismayingly.ngrok-free.dev";
    const editor = document.getElementById('editor');
    const netStatus = document.getElementById('net-status');
    const statusText = document.getElementById('status-text');
    
    // –ò–Ω—Å—Ç–∞–Ω—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
    const params = new URLSearchParams(window.location.search);
    let docId = params.get('id');
    const readOnly = params.get('view') === 'true';

    /**
     * INITIALIZATION
     */
    window.onload = () => {
        setupDocumentId();
        if (readOnly) initReadOnlyMode();
        setupAutoSave();
        loadDocumentContent();
        updateWordCount();
        initDragAndDrop();
    };

    function setupDocumentId() {
        if (!docId) {
            docId = 'clever_' + Math.random().toString(36).substr(2, 12);
            window.history.replaceState(null, '', `?id=${docId}`);
        }
        
        const fullUrl = window.location.href.split('&')[0];
        document.getElementById('edit-url').value = fullUrl;
        document.getElementById('view-url').value = fullUrl + '&view=true';
    }

    function initReadOnlyMode() {
        editor.contentEditable = "false";
        document.getElementById('toolbar').style.display = "none";
        document.getElementById('saveFab').style.display = "none";
        document.body.style.background = "#fff";
        document.title = "–ü—Ä–æ—Å–º–æ—Ç—Ä: " + docId;
    }

    /**
     * CORE EDITOR FUNCTIONS
     */
    function exec(command, value = null) {
        document.execCommand(command, false, value);
        editor.focus();
    }

    function setPaper(style) {
        editor.className = style;
        localStorage.setItem('clever_pref_style', style);
    }

    function toggleDarkMode() {
        document.body.classList.toggle('paper-dark');
        const isDark = document.body.classList.contains('paper-dark');
        editor.classList.toggle('paper-dark', isDark);
    }

    function insertImage() {
        const url = prompt("–í—Å—Ç–∞–≤—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (jpg, png, gif):");
        if (url) {
            const imgHtml = `<img src="${url}" alt="Image" ontouchstart="imgAction(this)">`;
            exec('insertHTML', imgHtml);
        }
    }

    function copyValue(id) {
        const input = document.getElementById(id);
        input.select();
        document.execCommand('copy');
        showToast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
    }

    /**
     * NETWORK LOGIC
     */
    async function loadDocumentContent() {
        updateNetIndicator(false, "–ó–ê–ì–†–£–ó–ö–ê...");
        try {
            const response = await fetch(`${API_HOST}/load/${docId}?cache_bust=${Date.now()}`);
            if (!response.ok) throw new Error("Server error");
            
            const data = await response.json();
            if (data.content && data.content.trim() !== "") {
                editor.innerHTML = data.content;
                updateNetIndicator(true, "–û–ë–õ–ê–ö–û –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–û");
            } else {
                updateNetIndicator(true, "–ù–û–í–´–ô –î–û–ö–£–ú–ï–ù–¢");
            }
        } catch (e) {
            updateNetIndicator(false, "–û–§–§–õ–ê–ô–ù –†–ï–ñ–ò–ú");
            const localBackup = localStorage.getItem('backup_' + docId);
            if (localBackup) editor.innerHTML = localBackup;
        }
    }

    async function forceSave() {
        const fab = document.getElementById('saveFab');
        fab.style.transform = "rotate(360deg) scale(1.2)";
        await performSave();
        setTimeout(() => fab.style.transform = "", 600);
    }

    async function performSave() {
        if (readOnly) return;

        const content = editor.innerHTML;
        localStorage.setItem('backup_' + docId, content);

        try {
            const response = await fetch(`${API_HOST}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: docId, content: content })
            });

            if (response.ok) {
                updateNetIndicator(true, "–ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–û–•–†–ê–ù–ï–ù–´");
                updateLastSaveTime();
            } else {
                throw new Error();
            }
        } catch (e) {
            updateNetIndicator(false, "–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø");
        }
    }

    /**
     * UTILS
     */
    function updateNetIndicator(online, text) {
        netStatus.className = "online-dot" + (online ? " active" : "");
        statusText.innerText = text;
    }

    function updateLastSaveTime() {
        const now = new Date();
        document.getElementById('last-save').innerText = `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
    }

    function updateWordCount() {
        const text = editor.innerText || "";
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const chars = text.length;
        document.getElementById('word-count').innerText = `–°–ª–æ–≤: ${words} | –°–∏–º–≤–æ–ª–æ–≤: ${chars}`;
    }

    function setupAutoSave() {
        let timer;
        editor.addEventListener('input', () => {
            updateWordCount();
            clearTimeout(timer);
            updateNetIndicator(true, "–ü–ï–ß–ê–¢–ê–ï–¢–ï...");
            timer = setTimeout(performSave, 2000); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏
        });
    }

    function initDragAndDrop() {
        editor.addEventListener('dragover', (e) => {
            e.preventDefault();
            editor.style.boxShadow = "0 0 20px var(--accent)";
        });

        editor.addEventListener('dragleave', () => {
           // editor.style.boxShadow = var(--shadow);
        });

        editor.addEventListener('drop', (e) => {
            e.preventDefault();
          //  editor.style.boxShadow = var(--shadow);
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = `<img src="${event.target.result}">`;
                    exec('insertHTML', img);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function showToast(msg) {
        const toast = document.createElement('div');
        toast.innerText = msg;
        toast.style.position = "fixed";
        toast.style.top = "20px";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.background = "var(--text-dark)";
        toast.style.color = "#fff";
        toast.style.padding = "10px 20px";
        toast.style.borderRadius = "20px";
        toast.style.zIndex = "3000";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à (–∫–∞–∫ –≤ Google Docs)
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case 's':
                    e.preventDefault();
                    forceSave();
                    break;
                case 'b':
                    e.preventDefault();
                    exec('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    exec('italic');
                    break;
            }
        }
    });

</script>
</body>
</html>
